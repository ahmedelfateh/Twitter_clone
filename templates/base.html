{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

    <title> {% block title  %} Tweetme.co {% endblock title %} </title>
  </head>

<style>

.red-color{
  color: red;
}

.gray-color{
  color: #CCC;
}

</style>


  <body>

    {% include "navbar.html" %}
    <div class='container'>

        {% block content %}  {% endblock content %}

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>


<script>

function getParameterByName(name, url) {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, '\\$&');
  var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
  results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

function loadTweetContainer(tweetContainerID){
            var query  = getParameterByName('q')
            var tweetList = [];
            var nextTweetUrl;
            var tweetContainer;
            if (tweetContainerID){
              tweetContainer = $("#" + tweetContainerID)
            } else {
              tweetContainer = $("#tweet-container")
            }
            var initialURL = tweetContainer.attr("data-url") || "/api/tweet/"            

function updateHashLinks(){
    $(".media-body").each(function(data){
        var hashtagRegex = /(^|\s)#([\w\d-]+)/g
        var usernameRegex = /(^|\s)@([\w\d-]+)/g
        var currentHtml = $(this).html();
        var newText;
        newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>")
        newText = newText.replace(usernameRegex, "$1@<a href='/tags/$2/'>$2</a>")
        $(this).html(newText)
        
    })
}
            function attachTweet(tweetValue, prepend, retweet){
                var datedisplay = tweetValue.date_display;
                var tweetContent = tweetValue.content;
                var tweetUser = tweetValue.user;
                var tweetId = tweetValue.id;
                var tweet_html;

                if (retweet && tweetValue.parent){
                    var mainTweet=tweetValue.parent
tweet_html =    "<div class=\"media\"><div class=\"media-body\">"
+ " <a href='"+ tweetUser.url +"' > " + tweetUser.username + " </a> " + " Retweeted || "
+ "at " + datedisplay +"<br/>" + mainTweet.content + "<br/>"
+ " By <a href='"+ mainTweet.user.url +"' > " + mainTweet.user.username + " </a>| "
+ mainTweet.date_display + " || " + "<a href='/tweet/"+mainTweet.id+"'>View</a> || "
+ "<a href='/tweet/" + tweetValue.id + "/retweet/'>Retweet</a>"
+ "</div></div>" + "<hr/>"

                } else {

tweet_html =    "<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br/>"
+ " By <a href='"+ tweetUser.url +"' > " + tweetUser.username + " </a>|| "
+ datedisplay + " || " + "<a href='/tweet/"+tweetId+"'>View</a> || " 
+ "<a href='/tweet/" + tweetValue.id + "/retweet/'>Retweet</a>"
+ "</div></div>" + "<hr/>"

                }
                if (prepend==true){
                    tweetContainer.prepend(tweet_html)
                } else {
                    tweetContainer.append(tweet_html)
                }
            }
            function parseTweets(){
                if (tweetList ==0){
                    tweetContainer.text("No Tweets Found")
                } else {
                        $.each(tweetList, function(key, value){
                        var tweetKey = value.key;
                        if (value.parent) {
                            attachTweet(value, false, true)
                        } else {
                            attachTweet(value)
                        }
                    })
            }
            }

            var nextTweetUrl;
            function fetchTweets(url){               
                var fecthUrl;

                if (!url){
                    fecthUrl = initialURL
                } else {
                    fecthUrl = url
                }

                $.ajax({
                    url: fecthUrl,
                    data: {
                        "q": query
                    },

                    method: "GET",
                    success: function(data){
                        tweetList = data.results
                        if (data.next){
                            nextTweetUrl = data.next
                        } else{
                            $("#loadmore").css("display", "none")
                        }
                        nextTweetUrl = data.next
                        parseTweets()
                        updateHashLinks()
                    },

                    error: function(data){
                        console.log("error")
                        console.log(data)
                    }   
            })
            }
            fetchTweets()
        $('#loadmore').click(function(event){
            event.preventDefault()
            if (nextTweetUrl){
                fetchTweets(nextTweetUrl)
            }
        })

var charsStart = 250;
  var charsCurrent = 0;
  $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")
  $("#tweet-form textarea").keyup(function(event){
      var tweetValue = $(this).val()
      charsCurrent = charsStart - tweetValue.length
      var spanChars = $("#tweetCharsLeft")
      spanChars.text(charsCurrent)
      if (charsCurrent > 0 ) {
         // remove classes
         spanChars.removeClass("grey-color")
         spanChars.removeClass("red-color")
      } else if (charsCurrent == 0) {
         // add grey class
         spanChars.removeClass("red-color")
         spanChars.addClass("grey-color")
      } else if (charsCurrent < 0) {
          // add red class
          spanChars.removeClass("grey-color")
          spanChars.addClass("red-color")
      }
  })


$("#tweet-form").submit(function(event){
    event.preventDefault()
    var this_ = $(this)
    var formData = this_.serialize()

 if (charsCurrent >= 0) {
        $.ajax({
          url: "/api/tweet/create/",
          data: formData,
          method: "POST",
          success: function(data){
            this_.find("input[type=text], textarea").val("")
            attachTweet(data, true)
            updateHashLinks()
           
          },
          error: function(data){
            console.log("error")
            console.log(data.statusText)
            console.log(data.status)
          }
        })
      }  else {
        console.log("Too Long Tweet")
    }

    })
}


</script>


{% block script %} {%endblock script%}

<script>
      $(document).ready(function(){
        var typingTimer;
        var doneInterval = 800; // in ms
        var searchInput = $("#navbar-search-form input[type=text]")
        var searchQuery;
        searchInput.keyup(function(event){
            searchQuery =  $(this).val()
            clearTimeout(typingTimer)
            typingTimer = setTimeout(doneSearchTyping, doneInterval)
            
        })
         searchInput.keydown(function(event){
            clearTimeout(typingTimer)  
        })
        function doneSearchTyping(){
          if (searchQuery){
            // do search
            var url = '/tweet/search/?q=' + searchQuery
            document.location.href = url;
          }
        }
      })
</script>

    <script src="{% static 'js/bootstrap.min.js' %}" ></script>
  </body>
</html>